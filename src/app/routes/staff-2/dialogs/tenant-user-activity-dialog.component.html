<div class="dialog-header">
  <h2 mat-dialog-title>
    <mat-icon>history</mat-icon>
    {{ 'staff.activity_dialog.title' | translate }}
  </h2>
  <div class="header-subtitle">{{ data.firstName }} {{ data.lastName }} ({{ data.username }})</div>
</div>

<mat-dialog-content class="dialog-content">
  <div class="form-section">
    <div class="filters">
      <mat-form-field appearance="outline">
        <mat-label>{{ 'staff.activity_dialog.filters.activity_type' | translate }}</mat-label>
        <mat-select [(ngModel)]="selectedActivityType" (selectionChange)="onFilterChange()">
          <mat-option [value]="null">{{ 'staff.activity_dialog.filters.all_activities' | translate }}</mat-option>
          @for (type of activityTypes; track type) {
            <mat-option [value]="type">{{ formatActivityType(type) }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>{{ 'staff.activity_dialog.filters.status' | translate }}</mat-label>
        <mat-select [(ngModel)]="selectedStatus" (selectionChange)="onFilterChange()">
          <mat-option [value]="null">{{ 'staff.activity_dialog.filters.all' | translate }}</mat-option>
          <mat-option [value]="true">{{ 'staff.activity_dialog.filters.success' | translate }}</mat-option>
          <mat-option [value]="false">{{ 'staff.activity_dialog.filters.failed' | translate }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    @if (isLoading()) {
      <div class="loading-container">
        <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
      </div>
    } @else {
      <div class="table-container">
        <table mat-table [dataSource]="filteredActivities()">
          <!-- Timestamp Column -->
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef>{{ 'staff.activity_dialog.columns.time' | translate }}</th>
            <td mat-cell *matCellDef="let activity">
              {{ activity.timestamp | date: 'short' }}
            </td>
          </ng-container>

          <!-- Activity Type Column -->
          <ng-container matColumnDef="activityType">
            <th mat-header-cell *matHeaderCellDef>{{ 'staff.activity_dialog.columns.type' | translate }}</th>
            <td mat-cell *matCellDef="let activity">
              <mat-chip [color]="getActivityTypeColor(activity.activityType)" selected>
                <mat-icon>{{ getActivityIcon(activity.activityType) }}</mat-icon>
                {{ formatActivityType(activity.activityType) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>{{ 'staff.activity_dialog.columns.description' | translate }}</th>
            <td mat-cell *matCellDef="let activity">
              {{ activity.description }}
            </td>
          </ng-container>

          <!-- IP Address Column -->
          <ng-container matColumnDef="ipAddress">
            <th mat-header-cell *matHeaderCellDef>{{ 'staff.activity_dialog.columns.ip_address' | translate }}</th>
            <td mat-cell *matCellDef="let activity">
              <code>{{ activity.ipAddress || 'N/A' }}</code>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="success">
            <th mat-header-cell *matHeaderCellDef>{{ 'staff.activity_dialog.columns.status' | translate }}</th>
            <td mat-cell *matCellDef="let activity">
              @if (activity.success) {
                <mat-icon class="success-icon" [matTooltip]="'staff.activity_dialog.filters.success' | translate">check_circle</mat-icon>
              } @else {
                <mat-icon class="error-icon" [matTooltip]="'staff.activity_dialog.filters.failed' | translate">cancel</mat-icon>
              }
            </td>
          </ng-container>

          <!-- Details Column -->
          <ng-container matColumnDef="details">
            <th mat-header-cell *matHeaderCellDef>{{ 'staff.activity_dialog.columns.details' | translate }}</th>
            <td mat-cell *matCellDef="let activity">
              @if (hasDetails(activity)) {
                <button mat-icon-button (click)="showDetails(activity)" [matTooltip]="'staff.activity_dialog.view_details' | translate">
                  <mat-icon>info</mat-icon>
                </button>
              } @else {
                <span class="no-details">-</span>
              }
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

          <!-- No Data Row -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell no-data" [colSpan]="displayedColumns.length">
              {{ 'staff.activity_dialog.no_data' | translate }}
            </td>
          </tr>
        </table>
      </div>

      <mat-paginator
        [length]="totalElements()"
        [pageSize]="pageSize()"
        [pageSizeOptions]="[10, 25, 50]"
        [pageIndex]="pageIndex()"
        (page)="onPageChange($event)"
        showFirstLastButtons
      >
      </mat-paginator>
    }
  </div>
</mat-dialog-content>

<div class="dialog-actions">
  <div class="action-left"></div>
  <div class="action-right">
    <button mat-button (click)="onClose()">{{ 'staff.activity_dialog.actions.close' | translate }}</button>
    <button mat-raised-button color="primary" (click)="exportActivity()">
      <mat-icon>download</mat-icon>
      {{ 'staff.activity_dialog.actions.export' | translate }}
    </button>
  </div>
</div>