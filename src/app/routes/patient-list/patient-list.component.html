<breadcrumb />

<mat-card>
  <mat-card-header>
    <mat-card-title>Patients</mat-card-title>
    <mat-card-subtitle>Manage patient records and information</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <!-- Action Bar -->
    <div class="action-bar m-b-16">
      <button mat-raised-button color="primary" (click)="createNewPatient()">
        <mat-icon>add</mat-icon>
        New Patient
      </button>
    </div>

    <!-- Search Bar -->
    <div class="search-section m-b-16">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Search patients</mat-label>
        <input
          #searchInput
          matInput
          placeholder="Search by name, ID, phone, or email..."
          [ngModel]="searchTerm()"
          (ngModelChange)="onSearchValueChange($event)"
          >
        <mat-icon matPrefix>search</mat-icon>
        @if (searchTerm()) {
          <button
            matSuffix
            mat-icon-button
            aria-label="Clear search"
            (click)="searchTerm.set(''); searchPatients()">
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>
      <button
        mat-raised-button
        [matBadge]="activeFilterCount() > 0 ? activeFilterCount().toString() : ''"
        [matBadgeHidden]="activeFilterCount() === 0"
        matBadgeColor="primary"
        matBadgeSize="medium"
        matBadgePosition="above after"
        (click)="toggleAdvancedFilters()"
        class="filter-toggle-btn m-l-16">
        <mat-icon>filter_list</mat-icon>
        Advanced Filters
      </button>
    </div>

    <!-- Advanced Filters Section -->
    @if (showAdvancedFilters()) {
      <mat-expansion-panel [expanded]="true" class="m-b-16">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>tune</mat-icon>
            Advanced Search Filters
          </mat-panel-title>
          <mat-panel-description>
            @if (activeFilterCount() > 0) {
              {{ activeFilterCount() }} active filter(s)
            } @else {
              Configure search criteria
            }
          </mat-panel-description>
        </mat-expansion-panel-header>

        <div class="filters-content">
          <!-- Balance Filters -->
          <div class="filter-section">
            <h4 class="filter-section-title">Balance Range</h4>
            <div class="filter-row">
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Balance From</mat-label>
                <input
                  matInput
                  type="number"
                  placeholder="0.00"
                  [ngModel]="balanceFrom()"
                  (ngModelChange)="balanceFrom.set($event)"
                  [disabled]="isLoading()">
                <span matPrefix>$</span>
              </mat-form-field>

              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Balance To</mat-label>
                <input
                  matInput
                  type="number"
                  placeholder="0.00"
                  [ngModel]="balanceTo()"
                  (ngModelChange)="balanceTo.set($event)"
                  [disabled]="isLoading()">
                <span matPrefix>$</span>
              </mat-form-field>

              <mat-checkbox
                [checked]="isBalanceNegative() === true"
                [indeterminate]="isBalanceNegative() === null"
                (change)="toggleTriState(isBalanceNegative)"
                class="filter-checkbox">
                Negative Balance Only
              </mat-checkbox>
            </div>
          </div>

          <mat-divider class="m-y-16"></mat-divider>

          <!-- Demographics & Status Filters -->
          <div class="filter-section">
            <h4 class="filter-section-title">Demographics & Status</h4>
            <div class="filter-row">
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Gender</mat-label>
                <mat-select [ngModel]="selectedGender()" (ngModelChange)="selectedGender.set($event)" [disabled]="isLoading()">
                  <mat-option value="">All</mat-option>
                  <mat-option value="M">Male</mat-option>
                  <mat-option value="F">Female</mat-option>
                  <mat-option value="O">Other</mat-option>
                </mat-select>
              </mat-form-field>

              <div class="toggle-field">
                <mat-slide-toggle
                  [ngModel]="isActive()"
                  (ngModelChange)="isActive.set($event)"
                  [disabled]="isLoading()">
                  Active Patients Only
                </mat-slide-toggle>
              </div>
            </div>
          </div>

          <mat-divider class="m-y-16"></mat-divider>

          <!-- Patient History Filters -->
          <div class="filter-section">
            <h4 class="filter-section-title">Patient History</h4>
            <div class="filter-checkboxes">
              <mat-checkbox
                [checked]="hasMedicalNotes() === true"
                [indeterminate]="hasMedicalNotes() === null"
                (change)="toggleTriState(hasMedicalNotes)">
                Has Medical Notes
              </mat-checkbox>

              <mat-checkbox
                [checked]="hasAppointments() === true"
                [indeterminate]="hasAppointments() === null"
                (change)="toggleTriState(hasAppointments)">
                Has Appointments
              </mat-checkbox>

              <mat-checkbox
                [checked]="hasTreatments() === true"
                [indeterminate]="hasTreatments() === null"
                (change)="toggleTriState(hasTreatments)">
                Has Treatments
              </mat-checkbox>
            </div>
          </div>

          <!-- Filter Actions -->
          <mat-action-row>
            <button mat-button (click)="clearFilters()">
              <mat-icon>clear</mat-icon>
              Clear All
            </button>
            <button mat-raised-button color="primary" (click)="applyFilters()">
              <mat-icon>search</mat-icon>
              Apply Filters
            </button>
          </mat-action-row>
        </div>
      </mat-expansion-panel>
    }

    <!-- Patient Table Component -->
    <app-patient-table
      [patients]="patients()"
      [isLoading]="isLoading()"
      [totalElements]="totalElements()"
      [pageSize]="pageSize()"
      [pageIndex]="pageIndex()"
      [searchTerm]="searchTerm()"
      [activeFilterCount]="activeFilterCount()"
      (pageChange)="onPageChange($event)"
      (sortChange)="onSortChange($event)"
      (viewPatient)="viewPatient($event)"
      (editPatient)="editPatient($event)"
    ></app-patient-table>
  </mat-card-content>
</mat-card>
