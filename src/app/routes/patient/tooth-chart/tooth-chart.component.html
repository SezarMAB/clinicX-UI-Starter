<div class="tooth-chart-container">
  <div class="tooth-chart-header">
    <h1>{{ 'tooth_chart.title' | translate }}</h1>
  </div>

  <div class="tooth-chart-layout">
    <div class="chart-section">
      <!-- Dental Chart -->
      <div class="dental-chart-card">
        <div class="chart-wrapper">
          <!-- Upper Jaw -->
          <div class="jaw-label">{{ 'tooth_chart.upper_jaw' | translate }}</div>
          <div class="jaw-row upper">
            @for (toothNum of upperTeeth; track toothNum) {
              <div class="tooth" 
                   [class.selected]="selectedTooth() === toothNum"
                   [attr.data-tooth]="toothNum"
                   (click)="selectTooth(toothNum)">
                <svg class="tooth-svg" viewBox="0 20 70 45">
                  @for (surface of ['roots', 'a', 'm', 'd', 'o', 'b', 'p']; track surface) {
                    <path [attr.d]="getSurfacePath(surface)"
                          class="surface"
                          [class.selection-active]="selectedTooth() === toothNum && isSurfaceSelected(surface)"
                          [style.fill]="getSurfaceFillColor(toothNum, surface)"
                          [attr.data-surface]="surface"
                          [attr.data-tooth]="toothNum" />
                  }
                </svg>
              </div>
            }
          </div>

          <!-- Numbering Row -->
          <div class="numbering-row">
            @for (num of [8, 7, 6, 5, 4, 3, 2, 1, 1, 2, 3, 4, 5, 6, 7, 8]; track $index) {
              <div class="number-item">{{ num }}</div>
            }
          </div>

          <!-- Lower Jaw -->
          <div class="jaw-row lower">
            @for (toothNum of lowerTeeth; track toothNum) {
              <div class="tooth"
                   [class.selected]="selectedTooth() === toothNum"
                   [attr.data-tooth]="toothNum"
                   (click)="selectTooth(toothNum)">
                <svg class="tooth-svg" viewBox="0 20 70 45">
                  @for (surface of ['roots', 'a', 'm', 'd', 'o', 'b', 'p']; track surface) {
                    <path [attr.d]="getSurfacePath(surface)"
                          class="surface"
                          [class.selection-active]="selectedTooth() === toothNum && isSurfaceSelected(surface)"
                          [style.fill]="getSurfaceFillColor(toothNum, surface)"
                          [attr.data-surface]="surface"
                          [attr.data-tooth]="toothNum" />
                  }
                </svg>
              </div>
            }
          </div>
          <div class="jaw-label">{{ 'tooth_chart.lower_jaw' | translate }}</div>
        </div>
      </div>

      <!-- Finding Palette -->
      <div class="finding-palette-card">
        <h3>{{ 'tooth_chart.finding' | translate }}</h3>
        <div class="findings-grid">
          @for (finding of findings; track finding.id) {
            @if (finding.name === '') {
              <div></div>
            } @else {
              <div class="finding-item"
                   [class.disabled]="!selectedTooth()"
                   (click)="addFindingToTooth(finding)">
                <div class="finding-icon">{{ finding.icon }}</div>
                <div>{{ ('tooth_chart.findings.' + finding.id) | translate }}</div>
              </div>
            }
          }
        </div>
      </div>

      <!-- Selected Tooth Info -->
      @if (selectedTooth()) {
        <div class="selected-tooth-info">
          <h4>{{ 'tooth_chart.finding_for_tooth' | translate: {toothNumber: selectedTooth()} }}</h4>
          <div>{{ 'tooth_chart.click_to_remove_findings' | translate }}</div>
          <div class="findings-list">
            @if (selectedToothData()?.findings?.length === 0) {
              <em>{{ 'tooth_chart.no_findings' | translate }}</em>
            } @else {
              @for (findingId of selectedToothData()?.findings || []; track findingId) {
                @if (getFindingById(findingId); as finding) {
                  <span class="finding-tag"
                        [title]="'tooth_chart.click_to_remove_findings' | translate"
                        (click)="removeFindingFromTooth(findingId)">
                    {{ ('tooth_chart.findings.' + finding.id) | translate }}
                  </span>
                }
              }
            }
          </div>
        </div>
      }
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Tooth Detail View -->
      <div class="tooth-detail-card" [class.placeholder]="!selectedTooth()">
        @if (selectedTooth()) {
          <h4>{{ 'tooth_chart.tooth_for_editing' | translate }}</h4>
          <div class="tooth-detail-svg-container">
            <svg class="tooth-svg" viewBox="0 20 70 45">
              @for (surface of ['roots', 'a', 'm', 'd', 'o', 'b', 'p']; track surface) {
                <path [attr.d]="getSurfacePath(surface)"
                      class="surface"
                      [class.selection-active]="isSurfaceSelected(surface)"
                      [style.fill]="getSurfaceFillColor(selectedTooth()!, surface)"
                      [attr.data-surface]="surface"
                      (click)="toggleSurfaceSelection(surface)" />
              }
            </svg>
          </div>
        } @else {
          <div class="placeholder-text">{{ 'tooth_chart.please_select_tooth' | translate }}</div>
        }
      </div>

      <div class="current-selection-card">
        <h4>{{ 'tooth_chart.currently_selected' | translate }}</h4>
        <div class="tooth-display" [class.has-selection]="selectedTooth()">
          {{ selectedTooth() ? ('tooth_chart.tooth' | translate: {number: selectedTooth()}) : ('tooth_chart.no_tooth_selected' | translate) }}
        </div>
      </div>

      <div class="sidebar-card" [class.disabled]="!areSurfaceSectionsEnabled()">
        <h3>{{ 'tooth_chart.general' | translate }}</h3>
        <div class="checkbox-group">
          <mat-checkbox [(ngModel)]="foreignWork"
                        (change)="onCheckboxChange('foreignWork', $event.checked)">
            {{ 'tooth_chart.foreign_work' | translate }}
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="replaceExisting"
                        (change)="onCheckboxChange('replaceExisting', $event.checked)">
            {{ 'tooth_chart.replace_existing_fillings' | translate }}
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="xrayOnly"
                        (change)="onCheckboxChange('xrayOnly', $event.checked)">
            {{ 'tooth_chart.xray_visible_only' | translate }}
          </mat-checkbox>
        </div>
      </div>

      <div class="sidebar-card" [class.disabled]="!areSurfaceSectionsEnabled()">
        <h3>{{ 'tooth_chart.caries' | translate }}</h3>
        <mat-radio-group [(ngModel)]="selectedCaries"
                         (change)="onCariesChange($event.value)"
                         class="caries-radio-group">
          <mat-radio-button value="undetermined" class="caries-option">
            <span class="caries-indicator" style="background: #9e9e9e"></span>
            {{ 'tooth_chart.undetermined' | translate }}
          </mat-radio-button>
          <mat-radio-button value="1" class="caries-option">
            <span class="caries-indicator" style="background: #90caf9"></span>
            {{ 'tooth_chart.grade' | translate: {level: 1} }}
          </mat-radio-button>
          <mat-radio-button value="2" class="caries-option">
            <span class="caries-indicator" style="background: #42a5f5"></span>
            {{ 'tooth_chart.grade' | translate: {level: 2} }}
          </mat-radio-button>
          <mat-radio-button value="3" class="caries-option">
            <span class="caries-indicator" style="background: #ef5350"></span>
            {{ 'tooth_chart.grade' | translate: {level: 3} }}
          </mat-radio-button>
          <mat-radio-button value="4" class="caries-option">
            <span class="caries-indicator" style="background: #d32f2f"></span>
            {{ 'tooth_chart.grade' | translate: {level: 4} }}
          </mat-radio-button>
          <mat-radio-button value="5" class="caries-option">
            <span class="caries-indicator" style="background: #590303"></span>
            {{ 'tooth_chart.grade' | translate: {level: 5} }}
          </mat-radio-button>
        </mat-radio-group>
      </div>

      <div class="sidebar-card" [class.disabled]="!areSurfaceSectionsEnabled()">
        <h3>{{ 'tooth_chart.treatment_need' | translate }}</h3>
        <mat-select [(ngModel)]="treatmentNeed"
                    (selectionChange)="onSelectChange('treatmentNeed', $event.value)"
                    [placeholder]="'tooth_chart.select' | translate">
          <mat-option value="">{{ 'tooth_chart.select' | translate }}</mat-option>
          <mat-option value="insufficient">{{ 'tooth_chart.insufficient' | translate }}</mat-option>
          <mat-option value="treatment_worthy">{{ 'tooth_chart.treatment_worthy' | translate }}</mat-option>
          <mat-option value="none">{{ 'tooth_chart.none' | translate }}</mat-option>
        </mat-select>
      </div>

      <div class="sidebar-card" [class.disabled]="!areSurfaceSectionsEnabled()">
        <h3>{{ 'tooth_chart.filling_material' | translate }}</h3>
        <mat-select [(ngModel)]="fillingMaterial"
                    (selectionChange)="onSelectChange('fillingMaterial', $event.value)"
                    [placeholder]="'tooth_chart.unknown' | translate">
          <mat-option value="">{{ 'tooth_chart.unknown' | translate }}</mat-option>
          <mat-option value="Amalgam">{{ 'tooth_chart.amalgam' | translate }}</mat-option>
          <mat-option value="Cerec">{{ 'tooth_chart.cerec' | translate }}</mat-option>
          <mat-option value="GlassIonomer">{{ 'tooth_chart.glass_ionomer' | translate }}</mat-option>
          <mat-option value="Gold">{{ 'tooth_chart.gold' | translate }}</mat-option>
          <mat-option value="Ceramic">{{ 'tooth_chart.ceramic' | translate }}</mat-option>
          <mat-option value="Composite">{{ 'tooth_chart.composite' | translate }}</mat-option>
        </mat-select>
      </div>

      <div class="action-buttons">
        <input type="file" 
               #fileInput
               class="file-input" 
               accept=".json"
               (change)="importData($event)" />
        <button mat-raised-button 
                class="import-btn"
                (click)="fileInput.click()">
          <mat-icon>upload_file</mat-icon>
          {{ 'tooth_chart.import_json' | translate }}
        </button>
        <button mat-raised-button 
                class="export-btn"
                (click)="exportData()">
          <mat-icon>download</mat-icon>
          {{ 'tooth_chart.download_json' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>