<div class="container">
  <h1>Zahnstatus bearbeiten</h1>

  <div class="main-layout">
    <div class="chart-section">
      <!-- Dental Chart -->
      <div class="chart-wrapper">
        <!-- Upper Jaw -->
        <div class="jaw-label">Oberkiefer</div>
        <div class="jaw-row upper">
          @for (toothNum of upperTeeth; track toothNum) {
            <div class="tooth" 
                 [class.selected]="selectedTooth() === toothNum"
                 [attr.data-tooth]="toothNum"
                 (click)="selectTooth(toothNum)">
              <svg class="tooth-svg" viewBox="0 20 70 45">
                @for (surface of ['roots', 'a', 'm', 'd', 'o', 'b', 'p']; track surface) {
                  <path [attr.d]="getSurfacePath(surface)"
                        class="surface"
                        [class.selection-active]="selectedTooth() === toothNum && isSurfaceSelected(surface)"
                        [style.fill]="getSurfaceFillColor(toothNum, surface)"
                        [attr.data-surface]="surface"
                        [attr.data-tooth]="toothNum" />
                }
              </svg>
            </div>
          }
        </div>

        <!-- Numbering Row -->
        <div class="numbering-row">
          @for (num of [8, 7, 6, 5, 4, 3, 2, 1, 1, 2, 3, 4, 5, 6, 7, 8]; track $index) {
            <div class="number-item">{{ num }}</div>
          }
        </div>

        <!-- Lower Jaw -->
        <div class="jaw-row lower">
          @for (toothNum of lowerTeeth; track toothNum) {
            <div class="tooth"
                 [class.selected]="selectedTooth() === toothNum"
                 [attr.data-tooth]="toothNum"
                 (click)="selectTooth(toothNum)">
              <svg class="tooth-svg" viewBox="0 20 70 45">
                @for (surface of ['roots', 'a', 'm', 'd', 'o', 'b', 'p']; track surface) {
                  <path [attr.d]="getSurfacePath(surface)"
                        class="surface"
                        [class.selection-active]="selectedTooth() === toothNum && isSurfaceSelected(surface)"
                        [style.fill]="getSurfaceFillColor(toothNum, surface)"
                        [attr.data-surface]="surface"
                        [attr.data-tooth]="toothNum" />
                }
              </svg>
            </div>
          }
        </div>
        <div class="jaw-label">Unterkiefer</div>
      </div>

      <!-- Finding Palette -->
      <div class="finding-palette">
        <h3>Befund</h3>
        <div class="findings-grid">
          @for (finding of findings; track finding.id) {
            @if (finding.name === '') {
              <div></div>
            } @else {
              <div class="finding-item"
                   [class.disabled]="!selectedTooth()"
                   (click)="addFindingToTooth(finding)">
                <div class="finding-icon">{{ finding.icon }}</div>
                <div>{{ finding.name }}</div>
              </div>
            }
          }
        </div>
      </div>

      <!-- Selected Tooth Info -->
      @if (selectedTooth()) {
        <div class="selected-tooth-info">
          <h4>Befund für Zahn <span>{{ selectedTooth() }}</span></h4>
          <div>Klicken Sie auf die Befunde unten, um sie zu entfernen:</div>
          <div class="findings-list">
            @if (selectedToothData()?.findings?.length === 0) {
              <em>Keine Befunde</em>
            } @else {
              @for (findingId of selectedToothData()?.findings || []; track findingId) {
                @if (getFindingById(findingId); as finding) {
                  <span class="finding-tag"
                        title="Klicken zum Entfernen"
                        (click)="removeFindingFromTooth(findingId)">
                    {{ finding.name }}
                  </span>
                }
              }
            }
          </div>
        </div>
      }
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Tooth Detail View -->
      <div class="tooth-detail-view" [class.placeholder]="!selectedTooth()">
        @if (selectedTooth()) {
          <h4>Zahn zur Bearbeitung</h4>
          <div class="tooth-detail-svg-container">
            <svg class="tooth-svg" viewBox="0 20 70 45">
              @for (surface of ['roots', 'a', 'm', 'd', 'o', 'b', 'p']; track surface) {
                <path [attr.d]="getSurfacePath(surface)"
                      class="surface"
                      [class.selection-active]="isSurfaceSelected(surface)"
                      [style.fill]="getSurfaceFillColor(selectedTooth()!, surface)"
                      [attr.data-surface]="surface"
                      (click)="toggleSurfaceSelection(surface)" />
              }
            </svg>
          </div>
        } @else {
          <div class="placeholder-text">Bitte einen Zahn aus der Übersicht auswählen.</div>
        }
      </div>

      <div class="current-selection">
        <h4>Aktuell ausgewählt:</h4>
        <div [class.selected-tooth]="selectedTooth()">
          {{ selectedTooth() ? 'Zahn ' + selectedTooth() : 'Kein Zahn ausgewählt' }}
        </div>
      </div>

      <div class="sidebar-section" [class.disabled]="!areSurfaceSectionsEnabled()">
        <h3>Allgemein</h3>
        <div class="checkbox-group">
          <mat-checkbox [(ngModel)]="fremdarbeit"
                        (change)="onCheckboxChange('fremdarbeit', $event.checked)">
            Fremdarbeit
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="ersetzen"
                        (change)="onCheckboxChange('ersetzen', $event.checked)">
            vorhandene Füllung(en) ersetzen
          </mat-checkbox>
          <mat-checkbox [(ngModel)]="roentgen"
                        (change)="onCheckboxChange('roentgen', $event.checked)">
            nur Röntgen sichtbar
          </mat-checkbox>
        </div>
      </div>

      <div class="sidebar-section" [class.disabled]="!areSurfaceSectionsEnabled()">
        <h3>Karies</h3>
        <mat-radio-group [(ngModel)]="selectedCaries"
                         (change)="onCariesChange($event.value)"
                         class="caries-colors">
          <mat-radio-button value="unbestimmt" class="caries-item">
            <div class="caries-color" style="background: #9e9e9e"></div>
            unbestimmt
          </mat-radio-button>
          <mat-radio-button value="1" class="caries-item">
            <div class="caries-color" style="background: #90caf9"></div>
            Grad 1
          </mat-radio-button>
          <mat-radio-button value="2" class="caries-item">
            <div class="caries-color" style="background: #42a5f5"></div>
            Grad 2
          </mat-radio-button>
          <mat-radio-button value="3" class="caries-item">
            <div class="caries-color" style="background: #ef5350"></div>
            Grad 3
          </mat-radio-button>
          <mat-radio-button value="4" class="caries-item">
            <div class="caries-color" style="background: #d32f2f"></div>
            Grad 4
          </mat-radio-button>
          <mat-radio-button value="5" class="caries-item">
            <div class="caries-color" style="background: #590303"></div>
            Grad 5
          </mat-radio-button>
        </mat-radio-group>
      </div>

      <div class="sidebar-section" [class.disabled]="!areSurfaceSectionsEnabled()">
        <h3>Behandlungsbedarf</h3>
        <mat-select [(ngModel)]="behandlungsbedarf"
                    (selectionChange)="onSelectChange('behandlungsbedarf', $event.value)"
                    placeholder="Auswählen...">
          <mat-option value="">Auswählen...</mat-option>
          <mat-option value="insuffizient">insuffizient</mat-option>
          <mat-option value="behandlungswürdig">behandlungswürdig</mat-option>
          <mat-option value="keiner">keiner</mat-option>
        </mat-select>
      </div>

      <div class="sidebar-section" [class.disabled]="!areSurfaceSectionsEnabled()">
        <h3>Füllmaterial</h3>
        <mat-select [(ngModel)]="fuellmaterial"
                    (selectionChange)="onSelectChange('fuellmaterial', $event.value)"
                    placeholder="Unbekannt">
          <mat-option value="">Unbekannt</mat-option>
          <mat-option value="Amalgam">Amalgam</mat-option>
          <mat-option value="Cerec">Cerec</mat-option>
          <mat-option value="Glasionomer">Glasionomer</mat-option>
          <mat-option value="Gold">Gold</mat-option>
          <mat-option value="Keramik">Keramik</mat-option>
          <mat-option value="Komposit">Komposit</mat-option>
        </mat-select>
      </div>

      <input type="file" 
             #fileInput
             class="file-input" 
             accept=".json"
             (change)="importData($event)" />
      <button mat-raised-button 
              color="warn"
              class="import-btn"
              (click)="fileInput.click()">
        Import JSON
      </button>
      <button mat-raised-button 
              color="primary"
              class="export-btn"
              (click)="exportData()">
        Download JSON
      </button>
    </div>
  </div>
</div>