<div class="treatment-timeline">
  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p class="mat-body-1">{{ 'treatments.loading' | translate }}</p>
    </div>
  }

  <!-- Error State -->
  @else if (error()) {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon color="warn">error_outline</mat-icon>
        <p>{{ error() || 'treatments.error.load_failed' | translate }}</p>
      </mat-card-content>
    </mat-card>
  }

  <!-- Timeline Content -->
  @else {
    @for (group of timelineGroups(); track group.month + group.year) {
    <div class="timeline-group">
      <!-- Group Header -->
      <div 
        class="group-header" 
        (click)="toggleGroup(group)"
        [class.expanded]="isGroupExpanded(group)">
        <div class="group-title">
          <h3>{{ group.month }} {{ showYear() ? group.year : '' }}</h3>
          <mat-chip>{{ group.treatments.length }}</mat-chip>
        </div>
        <mat-icon class="expand-icon">
          {{ isGroupExpanded(group) ? 'expand_less' : 'expand_more' }}
        </mat-icon>
      </div>

      <!-- Group Content -->
      @if (isGroupExpanded(group)) {
        <div class="timeline-content">
          @for (treatment of group.treatments; track treatment.treatmentId || treatment.id) {
            <div class="timeline-item" [class]="getStatusClass(treatment.status)">
              <div class="timeline-marker">
                <mat-icon>{{ getStatusIcon(treatment.status) }}</mat-icon>
              </div>
              
              <div class="timeline-card" (click)="onTreatmentClick(treatment)">
                <div class="timeline-card-header">
                  <div class="treatment-main">
                    <h4 class="treatment-name">{{ treatment.treatmentName || treatment.treatmentType }}</h4>
                    <div class="treatment-badges">
                      @if (treatment.toothNumber) {
                        <span class="tooth-badge">
                          <mat-icon>dentistry</mat-icon>
                          #{{ treatment.toothNumber }}
                        </span>
                      }
                      @if (treatment.visitType) {
                        <span class="visit-type-badge">{{ treatment.visitType }}</span>
                      }
                    </div>
                  </div>
                  <div class="treatment-right">
                    <span class="treatment-cost">{{ treatment.cost | currency:'USD':'symbol':'1.0-0' }}</span>
                    <mat-chip [class]="getStatusClass(treatment.status)" class="status-chip">
                      {{ ('treatments.status.' + treatment.status.toLowerCase()) | translate }}
                    </mat-chip>
                  </div>
                </div>

                <div class="timeline-card-body">
                  <div class="treatment-details">
                    <span class="detail-item">
                      <mat-icon>person_outline</mat-icon>
                      {{ treatment.doctorName || treatment.performedBy }}
                    </span>
                    
                    <span class="detail-item">
                      <mat-icon>access_time</mat-icon>
                      {{ treatment.treatmentTime ? treatment.treatmentTime.substring(0, 5) : formatTime(treatment.treatmentDate) }}
                    </span>
                    
                    @if (treatment.durationMinutes) {
                      <span class="detail-item">
                        <mat-icon>timer</mat-icon>
                        {{ treatment.durationMinutes }}min
                      </span>
                    }
                  </div>

                  @if (treatment.notes) {
                    <div class="treatment-notes">
                      {{ treatment.notes }}
                    </div>
                  }

                  @if (treatment.nextAppointment) {
                    <div class="next-appointment">
                      <mat-icon>event</mat-icon>
                      <span>{{ 'treatments.next' | translate }}: {{ treatment.nextAppointment }}</span>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  } @empty {
    <div class="empty-timeline">
      <mat-icon>timeline</mat-icon>
      <p>{{ 'treatments.no_timeline_data' | translate }}</p>
    </div>
  }
  }
</div>