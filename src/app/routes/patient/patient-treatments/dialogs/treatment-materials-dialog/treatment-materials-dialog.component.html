<h1 mat-dialog-title>{{ 'treatments.materials.title' | translate }}</h1>

<mat-dialog-content>
  <form [formGroup]="materialsForm">
    <!-- Materials table -->
    <div class="materials-table-container">
      <div class="table-header">
        <h3>{{ 'treatments.materials.list' | translate }}</h3>
        <button mat-button color="primary" type="button" (click)="addMaterial()">
          <mat-icon>add</mat-icon>
          {{ 'treatments.materials.add_item' | translate }}
        </button>
      </div>

      <table class="materials-table">
        <thead>
          <tr>
            <th>{{ 'treatments.materials.name' | translate }}</th>
            <th>{{ 'treatments.materials.category' | translate }}</th>
            <th>{{ 'treatments.materials.quantity' | translate }}</th>
            <th>{{ 'treatments.materials.unit_price' | translate }}</th>
            <th>{{ 'treatments.materials.total' | translate }}</th>
            <th></th>
          </tr>
        </thead>
        <tbody formArrayName="materials">
          @for (material of materialsArray.controls; track $index) {
            <tr [formGroupName]="$index">
              <td>
                <mat-form-field class="dense-field">
                  <input matInput 
                         formControlName="name"
                         [placeholder]="'treatments.materials.name_placeholder' | translate"
                         [matAutocomplete]="auto">
                  <mat-autocomplete #auto="matAutocomplete">
                    @for (item of availableMaterials(); track item.id) {
                      <mat-option [value]="item.name" (click)="selectPredefinedMaterial(item, $index)">
                        {{ item.name }}
                      </mat-option>
                    }
                  </mat-autocomplete>
                  @if (getErrorMessage('name', $index)) {
                    <mat-error>{{ getErrorMessage('name', $index) }}</mat-error>
                  }
                </mat-form-field>
              </td>
              <td>
                <mat-form-field class="dense-field">
                  <mat-select formControlName="category" 
                              [placeholder]="'treatments.materials.category_placeholder' | translate">
                    @for (category of categories; track category) {
                      <mat-option [value]="category">{{ 'treatments.materials.categories.' + category.toLowerCase() | translate }}</mat-option>
                    }
                  </mat-select>
                  @if (getErrorMessage('category', $index)) {
                    <mat-error>{{ getErrorMessage('category', $index) }}</mat-error>
                  }
                </mat-form-field>
              </td>
              <td>
                <mat-form-field class="dense-field small-field">
                  <input matInput 
                         type="number" 
                         formControlName="quantity"
                         min="1">
                  @if (getErrorMessage('quantity', $index)) {
                    <mat-error>{{ getErrorMessage('quantity', $index) }}</mat-error>
                  }
                </mat-form-field>
              </td>
              <td>
                <mat-form-field class="dense-field small-field">
                  <span matTextPrefix>$</span>
                  <input matInput 
                         type="number" 
                         formControlName="unitPrice"
                         min="0"
                         step="0.01">
                  @if (getErrorMessage('unitPrice', $index)) {
                    <mat-error>{{ getErrorMessage('unitPrice', $index) }}</mat-error>
                  }
                </mat-form-field>
              </td>
              <td class="total-cell">
                <span class="total-price">${{ material.get('totalPrice')?.value | number:'1.2-2' }}</span>
              </td>
              <td>
                <button mat-icon-button 
                        color="warn" 
                        type="button"
                        [matTooltip]="'common.remove' | translate"
                        (click)="removeMaterial($index)"
                        [disabled]="materialsArray.length === 1">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>

      <!-- Total cost -->
      <div class="total-section">
        <mat-divider></mat-divider>
        <div class="total-row">
          <span class="total-label">{{ 'treatments.materials.total_cost' | translate }}:</span>
          <span class="total-amount">${{ totalCost() | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- Quick add section -->
    <div class="quick-add-section">
      <h4>{{ 'treatments.materials.quick_add' | translate }}</h4>
      <div class="quick-add-chips">
        @for (material of availableMaterials() | slice:0:6; track material.id) {
          <button mat-stroked-button 
                  type="button"
                  class="material-chip"
                  (click)="addMaterial(material)">
            <mat-icon>add</mat-icon>
            {{ material.name }}
            <span class="chip-price">${{ material.unitPrice }}</span>
          </button>
        }
      </div>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">
    {{ 'common.cancel' | translate }}
  </button>
  <button mat-raised-button 
          color="primary" 
          (click)="onSubmit()"
          [disabled]="materialsForm.invalid || saving()">
    @if (saving()) {
      <mat-spinner diameter="20"></mat-spinner>
    } @else {
      {{ 'common.save' | translate }}
    }
  </button>
</mat-dialog-actions>