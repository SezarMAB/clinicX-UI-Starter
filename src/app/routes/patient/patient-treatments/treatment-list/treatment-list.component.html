<div class="treatment-list-container" [class.embedded]="embedded">
  <!-- Header -->
  @if (!embedded) {
    <mat-toolbar class="page-toolbar">
      <h1>{{ 'treatments.title' | translate }}</h1>
      <span class="spacer"></span>

      <!-- Action buttons -->
      <button
        mat-button
        (click)="exportTreatments()"
        [matTooltip]="'treatments.export' | translate">
        <mat-icon>download</mat-icon>
        {{ 'common.export' | translate }}
      </button>

      <button
        matButton="filled"
        (click)="createTreatment()"
        *ngxPermissionsOnly="['CREATE_TREATMENT', 'ADMIN', 'DOCTOR']">
        <mat-icon>add</mat-icon>
        {{ 'treatments.add_new' | translate }}
      </button>
    </mat-toolbar>
  }

  <!-- Summary Cards -->
<!--  <div class="summary-cards">-->
<!--    <mat-card class="summary-card">-->
<!--      <mat-card-content>-->
<!--        <div class="summary-icon planned">-->
<!--          <mat-icon>schedule</mat-icon>-->
<!--        </div>-->
<!--        <div class="summary-info">-->
<!--          <h3>{{ plannedCount() }}</h3>-->
<!--          <p>{{ 'treatments.status.planned' | translate }}</p>-->
<!--        </div>-->
<!--      </mat-card-content>-->
<!--    </mat-card>-->

<!--    <mat-card class="summary-card">-->
<!--      <mat-card-content>-->
<!--        <div class="summary-icon in-progress">-->
<!--          <mat-icon>pending</mat-icon>-->
<!--        </div>-->
<!--        <div class="summary-info">-->
<!--          <h3>{{ inProgressCount() }}</h3>-->
<!--          <p>{{ 'treatments.status.in_progress' | translate }}</p>-->
<!--        </div>-->
<!--      </mat-card-content>-->
<!--    </mat-card>-->

<!--    <mat-card class="summary-card">-->
<!--      <mat-card-content>-->
<!--        <div class="summary-icon completed">-->
<!--          <mat-icon>check_circle</mat-icon>-->
<!--        </div>-->
<!--        <div class="summary-info">-->
<!--          <h3>{{ completedCount() }}</h3>-->
<!--          <p>{{ 'treatments.status.completed' | translate }}</p>-->
<!--        </div>-->
<!--      </mat-card-content>-->
<!--    </mat-card>-->

<!--    <mat-card class="summary-card">-->
<!--      <mat-card-content>-->
<!--        <div class="summary-icon total-cost">-->
<!--          <mat-icon>payments</mat-icon>-->
<!--        </div>-->
<!--        <div class="summary-info">-->
<!--          <h3>{{ totalCost() | currency:'USD':'symbol':'1.0-0' }}</h3>-->
<!--          <p>{{ 'treatments.total_cost' | translate }}</p>-->
<!--        </div>-->
<!--      </mat-card-content>-->
<!--    </mat-card>-->
<!--  </div>-->

  <!-- Filters -->
  <mat-card class="filter-card">
    <mat-card-content>
      <div class="filter-row">
        <mat-form-field class="search-field">
          <mat-label>{{ 'treatments.search' | translate }}</mat-label>
          <input
            matInput
            [ngModel]="searchTerm()"
            (ngModelChange)="searchTerm.set($event)"
            [placeholder]="'treatments.search_placeholder' | translate">
          <mat-icon matPrefix>search</mat-icon>
          @if (searchTerm()) {
            <button
              matSuffix
              mat-icon-button
              (click)="searchTerm.set('')"
              [attr.aria-label]="'common.clear' | translate">
              <mat-icon>close</mat-icon>
            </button>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>{{ 'treatments.filter_by_status' | translate }}</mat-label>
          <mat-select [ngModel]="selectedStatus()" (ngModelChange)="selectedStatus.set($event)">
            <mat-option value="">{{ 'common.all' | translate }}</mat-option>
            @for (status of statusOptions; track status) {
              <mat-option [value]="status">
                <mat-icon [class]="'status-icon ' + status.toLowerCase()">
                  {{ getStatusIcon(status) }}
                </mat-icon>
                {{ 'treatments.status.' + status.toLowerCase() | translate }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field>
          <mat-label>{{ 'treatments.filter_by_doctor' | translate }}</mat-label>
          <mat-select [ngModel]="selectedDoctor()" (ngModelChange)="selectedDoctor.set($event)">
            <mat-option value="">{{ 'common.all' | translate }}</mat-option>
            @for (doctor of uniqueDoctors(); track doctor) {
              <mat-option [value]="doctor">
                <mat-icon>person</mat-icon>
                {{ doctor }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        @if (searchTerm() || selectedStatus() || selectedDoctor()) {
          <button
            mat-button
            color="primary"
            (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            {{ 'common.clear_filters' | translate }}
          </button>
        }

        <span class="spacer"></span>

        @if (embedded) {
          <button
            matButton="filled"
            (click)="createTreatment()"
            *ngxPermissionsOnly="['CREATE_TREATMENT', 'ADMIN', 'DOCTOR']">
            <mat-icon>add</mat-icon>
           {{ 'treatments.add_new' | translate }}
          </button>

        }
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Material Table -->
<!--  <div class="table-container">-->
<!--    <mat-card>-->
<!--      <mat-card-content>-->
        @if (loading()) {
          <div class="loading-container">
            <mat-spinner diameter="40"></mat-spinner>
            <p>{{ 'treatments.loading' | translate }}</p>
          </div>
        } @else {
          <!-- Show paginating overlay when switching pages -->
          @if (isPaginating()) {
            <div class="pagination-overlay">
              <mat-progress-bar mode="indeterminate" color="primary"></mat-progress-bar>
            </div>
          }
          
          <div class="table-wrapper" [class.paginating]="isPaginating()">
            <mat-table
              [dataSource]="dataSource"
              [trackBy]="trackByFn"
              matSort
              #sort="matSort"
              (matSortChange)="onSortChange($event)"
              class="treatment-table">

              <!-- Date Column -->
              <ng-container matColumnDef="treatmentDate">
                <mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ 'treatments.table.date' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let treatment">
                  {{ getFormattedDateTime(treatment.treatmentDate, treatment.treatmentTime) }}
                </mat-cell>
              </ng-container>

              <!-- Visit Type Column -->
              <ng-container matColumnDef="visitType">
                <mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ 'treatments.table.visit_type' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let treatment">
                  {{ treatment.visitType }}
                </mat-cell>
              </ng-container>

              <!-- Treatment Name Column -->
              <ng-container matColumnDef="treatmentName">
                <mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ 'treatments.table.treatment' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let treatment">
                  {{ treatment.treatmentName }}
                </mat-cell>
              </ng-container>

              <!-- Tooth Number Column -->
              <ng-container matColumnDef="toothNumber">
                <mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ 'treatments.table.tooth' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let treatment">
                  {{ getFormattedToothNumber(treatment.toothNumber) }}
                </mat-cell>
              </ng-container>

              <!-- Doctor Name Column -->
              <ng-container matColumnDef="doctorName">
                <mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ 'treatments.table.doctor' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let treatment">
                  {{ treatment.doctorName }}
                </mat-cell>
              </ng-container>

              <!-- Duration Column -->
              <ng-container matColumnDef="durationMinutes">
                <mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ 'treatments.table.duration' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let treatment">
                  {{ getFormattedDuration(treatment.durationMinutes) }}
                </mat-cell>
              </ng-container>

              <!-- Cost Column -->
              <ng-container matColumnDef="cost">
                <mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ 'treatments.table.cost' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let treatment">
                  {{ getFormattedCost(treatment.cost) }}
                </mat-cell>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ 'treatments.table.status' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let treatment">
                  <mat-icon [class]="'status-icon ' + treatment.status.toLowerCase()">
                    {{ getStatusIcon(treatment.status) }}
                  </mat-icon>
                </mat-cell>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <mat-header-cell *matHeaderCellDef>
                  {{ 'treatments.table.actions' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let treatment">
                  <button
                    mat-icon-button
                    [matMenuTriggerFor]="menu"
                    (click)="$event.stopPropagation()"
                    [attr.aria-label]="'treatments.table.actions' | translate">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="viewTreatmentDetails(treatment)">
                      <mat-icon>visibility</mat-icon>
                      <span>{{ 'treatments.table.view_details' | translate }}</span>
                    </button>
                    <button mat-menu-item (click)="editTreatment(treatment)">
                      <mat-icon>edit</mat-icon>
                      <span>{{ 'treatments.table.edit' | translate }}</span>
                    </button>
                    <button mat-menu-item (click)="deleteTreatment(treatment)">
                      <mat-icon>delete</mat-icon>
                      <span>{{ 'treatments.table.delete' | translate }}</span>
                    </button>
                  </mat-menu>
                </mat-cell>
              </ng-container>

              <mat-header-row *matHeaderRowDef="displayedColumns" />
              <mat-row *matRowDef="let row; columns: displayedColumns" class="treatment-row" />
            </mat-table>
          </div>

          <!-- Paginator -->
          <mat-paginator
            #paginator
            [pageSizeOptions]="[10, 20, 50, 100]"
            [pageSize]="pageSize()"
            [pageIndex]="pageIndex()"
            [length]="totalElements()"
            [showFirstLastButtons]="true"
            (page)="onPageChange($event)">
          </mat-paginator>
        }

  <!-- Empty State -->
  @if (filteredTreatments().length === 0 && !loading()) {
    <div class="empty-state">
      <mat-icon>medical_services</mat-icon>
      <h3>{{ 'treatments.no_treatments' | translate }}</h3>
      <p>{{ 'treatments.no_treatments_description' | translate }}</p>
      @if (!embedded) {
        <button
          matButton="filled"
          (click)="createTreatment()"
          *ngxPermissionsOnly="['CREATE_TREATMENT', 'ADMIN', 'DOCTOR']">
          <mat-icon>add</mat-icon>
          {{ 'treatments.add_first' | translate }}
        </button>
      }
    </div>
  }
</div>
