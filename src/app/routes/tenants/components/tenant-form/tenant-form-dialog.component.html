<h2 mat-dialog-title>
  {{ data.mode === 'create' ? 'Create New Tenant' : 'Edit Tenant' }}
</h2>

<mat-dialog-content>
  @if (data.mode === 'create') {
    <mat-stepper #stepper linear>
      <!-- Step 1: Basic Information -->
      <mat-step [stepControl]="basicInfoForm" label="Basic Information">
        <form [formGroup]="basicInfoForm" class="form-step">
          <mat-form-field>
            <mat-label>Tenant Name</mat-label>
            <input matInput formControlName="name" placeholder="Acme Clinic" />
            <mat-icon matSuffix>business</mat-icon>
            @if (basicInfoForm.controls.name.hasError('required')) {
              <mat-error>Name is required</mat-error>
            }
            @if (basicInfoForm.controls.name.hasError('minlength')) {
              <mat-error>Name must be at least 3 characters</mat-error>
            }
            @if (basicInfoForm.controls.name.hasError('maxlength')) {
              <mat-error>Name must not exceed 100 characters</mat-error>
            }
          </mat-form-field>

          <mat-form-field>
            <mat-label>Subdomain</mat-label>
            <input
              matInput
              formControlName="subdomain"
              placeholder="acme"
              [readonly]="isProcessing()"
            />
            <mat-icon matSuffix>link</mat-icon>
            <mat-hint>.clinic.com</mat-hint>
            @if (basicInfoForm.controls.subdomain.pending) {
              <mat-hint align="end">
                <mat-spinner diameter="16"></mat-spinner>
                Checking availability...
              </mat-hint>
            }
            @if (basicInfoForm.controls.subdomain.hasError('required')) {
              <mat-error>Subdomain is required</mat-error>
            }
            @if (basicInfoForm.controls.subdomain.hasError('pattern')) {
              <mat-error>Only lowercase letters, numbers, and hyphens allowed</mat-error>
            }
            @if (basicInfoForm.controls.subdomain.hasError('minlength')) {
              <mat-error>Subdomain must be at least 3 characters</mat-error>
            }
            @if (basicInfoForm.controls.subdomain.hasError('maxlength')) {
              <mat-error>Subdomain must not exceed 50 characters</mat-error>
            }
            @if (basicInfoForm.controls.subdomain.hasError('unavailable')) {
              <mat-error>This subdomain is already taken</mat-error>
            }
          </mat-form-field>

          <mat-form-field>
            <mat-label>Specialty</mat-label>
            <mat-select formControlName="specialty">
              <mat-option value="CLINIC">Clinic</mat-option>
              <!-- TODO implement the default for default realm              -->
              <mat-option value="DEFAULT" disabled>Default</mat-option>
              <mat-option value="DENTAL">Dental</mat-option>
              <mat-option value="APPOINTMENTS">Appointments</mat-option>
              <mat-option value="CHRORG">Chronic Care</mat-option>
            </mat-select>
            <mat-icon matSuffix>medical_services</mat-icon>
          </mat-form-field>

          <div class="step-actions">
            <button
              mat-button
              matStepperNext
              [disabled]="basicInfoForm.invalid || basicInfoForm.pending"
            >
              Next
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Step 2: Contact Information -->
      <mat-step [stepControl]="contactForm" label="Contact Information">
        <form [formGroup]="contactForm" class="form-step">
          <mat-form-field>
            <mat-label>Contact Email</mat-label>
            <input matInput formControlName="contactEmail" type="email" />
            <mat-icon matSuffix>email</mat-icon>
            @if (contactForm.controls.contactEmail.hasError('required')) {
              <mat-error>Email is required</mat-error>
            }
            @if (contactForm.controls.contactEmail.hasError('email')) {
              <mat-error>Invalid email format</mat-error>
            }
          </mat-form-field>

          <mat-form-field>
            <mat-label>Contact Phone</mat-label>
            <input matInput formControlName="contactPhone" placeholder="+1 234 567 8900" />
            <mat-icon matSuffix>phone</mat-icon>
            @if (contactForm.controls.contactPhone.hasError('pattern')) {
              <mat-error>Invalid phone number format</mat-error>
            }
          </mat-form-field>

          <mat-form-field>
            <mat-label>Address</mat-label>
            <textarea matInput formControlName="address" rows="3"></textarea>
            <mat-icon matSuffix>location_on</mat-icon>
          </mat-form-field>

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Previous
            </button>
            <button mat-button matStepperNext [disabled]="contactForm.invalid">
              Next
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Step 3: Subscription -->
      <mat-step [stepControl]="subscriptionForm" label="Subscription">
        <form [formGroup]="subscriptionForm" class="form-step">
          <mat-form-field>
            <mat-label>Subscription Plan</mat-label>
            <mat-select formControlName="subscriptionPlan">
              <mat-option value="BASIC">Basic</mat-option>
              <mat-option value="STANDARD">Standard</mat-option>
              <mat-option value="PREMIUM">Premium</mat-option>
              <mat-option value="ENTERPRISE">Enterprise</mat-option>
            </mat-select>
            <mat-icon matSuffix>payments</mat-icon>
          </mat-form-field>

          <div class="form-row">
            <mat-form-field>
              <mat-label>Max Users</mat-label>
              <input matInput formControlName="maxUsers" type="number" min="1" />
              <mat-icon matSuffix>group</mat-icon>
              @if (subscriptionForm.controls.maxUsers.hasError('required')) {
                <mat-error>Max users is required</mat-error>
              }
              @if (subscriptionForm.controls.maxUsers.hasError('min')) {
                <mat-error>Must be at least 1</mat-error>
              }
            </mat-form-field>

            <mat-form-field>
              <mat-label>Max Patients</mat-label>
              <input matInput formControlName="maxPatients" type="number" min="1" />
              <mat-icon matSuffix>folder_shared</mat-icon>
              @if (subscriptionForm.controls.maxPatients.hasError('required')) {
                <mat-error>Max patients is required</mat-error>
              }
              @if (subscriptionForm.controls.maxPatients.hasError('min')) {
                <mat-error>Must be at least 1</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Previous
            </button>
            <button mat-button matStepperNext [disabled]="subscriptionForm.invalid">
              Next
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Step 4: Admin User -->
      <mat-step [stepControl]="adminForm" label="Admin User">
        <form [formGroup]="adminForm" class="form-step">
          <div class="form-row">
            <mat-form-field>
              <mat-label>First Name</mat-label>
              <input matInput formControlName="adminFirstName" />
              <mat-icon matSuffix>person</mat-icon>
              @if (adminForm.controls.adminFirstName.hasError('required')) {
                <mat-error>First name is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field>
              <mat-label>Last Name</mat-label>
              <input matInput formControlName="adminLastName" />
              @if (adminForm.controls.adminLastName.hasError('required')) {
                <mat-error>Last name is required</mat-error>
              }
            </mat-form-field>
          </div>

          <mat-form-field>
            <mat-label>Admin Username</mat-label>
            <input matInput formControlName="adminUsername" />
            <mat-icon matSuffix>account_circle</mat-icon>
            @if (adminForm.controls.adminUsername.hasError('required')) {
              <mat-error>Username is required</mat-error>
            }
            @if (adminForm.controls.adminUsername.hasError('minlength')) {
              <mat-error>Username must be at least 3 characters</mat-error>
            }
            @if (adminForm.controls.adminUsername.hasError('maxlength')) {
              <mat-error>Username must not exceed 50 characters</mat-error>
            }
          </mat-form-field>

          <mat-form-field>
            <mat-label>Admin Email</mat-label>
            <input matInput formControlName="adminEmail" type="email" />
            <mat-icon matSuffix>email</mat-icon>
            @if (adminForm.controls.adminEmail.hasError('required')) {
              <mat-error>Email is required</mat-error>
            }
            @if (adminForm.controls.adminEmail.hasError('email')) {
              <mat-error>Invalid email format</mat-error>
            }
          </mat-form-field>

          <mat-form-field>
            <mat-label>Admin Password</mat-label>
            <input
              matInput
              formControlName="adminPassword"
              [type]="showPassword() ? 'text' : 'password'"
            />
            <button
              mat-icon-button
              matSuffix
              (click)="showPassword.set(!showPassword())"
              type="button"
            >
              <mat-icon>{{ showPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            @if (adminForm.controls.adminPassword.hasError('required')) {
              <mat-error>Password is required</mat-error>
            }
            @if (adminForm.controls.adminPassword.hasError('minlength')) {
              <mat-error>Password must be at least 8 characters</mat-error>
            }
          </mat-form-field>

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Previous
            </button>
            <button
              mat-raised-button
              color="primary"
              (click)="onSubmit()"
              [disabled]="!isFormValid() || isProcessing()"
            >
              @if (isProcessing()) {
                <mat-spinner diameter="20"></mat-spinner>
                Creating...
              } @else {
                <ng-container>
                  <mat-icon>check</mat-icon>
                  Create Tenant
                </ng-container>
              }
            </button>
          </div>
        </form>
      </mat-step>
    </mat-stepper>
  } @else {
    <!-- Edit Mode -->
    @if (editForm) {
      <form [formGroup]="editForm" class="edit-form">
        <mat-form-field>
          <mat-label>Tenant Name</mat-label>
          <input matInput formControlName="name" />
          <mat-icon matSuffix>business</mat-icon>
          @if (editForm.controls.name.hasError('minlength')) {
            <mat-error>Name must be at least 3 characters</mat-error>
          }
          @if (editForm.controls.name.hasError('maxlength')) {
            <mat-error>Name must not exceed 100 characters</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Contact Email</mat-label>
          <input matInput formControlName="contactEmail" type="email" />
          <mat-icon matSuffix>email</mat-icon>
          @if (editForm.controls.contactEmail.hasError('email')) {
            <mat-error>Invalid email format</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Contact Phone</mat-label>
          <input matInput formControlName="contactPhone" />
          <mat-icon matSuffix>phone</mat-icon>
          @if (editForm.controls.contactPhone.hasError('pattern')) {
            <mat-error>Invalid phone number format</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Address</mat-label>
          <textarea matInput formControlName="address" rows="3"></textarea>
          <mat-icon matSuffix>location_on</mat-icon>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Subscription Plan</mat-label>
          <mat-select formControlName="subscriptionPlan">
            <mat-option value="BASIC">Basic</mat-option>
            <mat-option value="STANDARD">Standard</mat-option>
            <mat-option value="PREMIUM">Premium</mat-option>
            <mat-option value="ENTERPRISE">Enterprise</mat-option>
          </mat-select>
          <mat-icon matSuffix>payments</mat-icon>
        </mat-form-field>

        <div class="form-row">
          <mat-form-field>
            <mat-label>Max Users</mat-label>
            <input matInput formControlName="maxUsers" type="number" min="1" />
            <mat-icon matSuffix>group</mat-icon>
            @if (editForm.controls.maxUsers.hasError('min')) {
              <mat-error>Must be at least 1</mat-error>
            }
          </mat-form-field>

          <mat-form-field>
            <mat-label>Max Patients</mat-label>
            <input matInput formControlName="maxPatients" type="number" min="1" />
            <mat-icon matSuffix>folder_shared</mat-icon>
            @if (editForm.controls.maxPatients.hasError('min')) {
              <mat-error>Must be at least 1</mat-error>
            }
          </mat-form-field>
        </div>
      </form>
    }
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" [disabled]="isProcessing()">Cancel</button>
  @if (data.mode === 'edit') {
    <button
      mat-raised-button
      color="primary"
      (click)="onSubmit()"
      [disabled]="editForm?.invalid || isProcessing()"
    >
      @if (isProcessing()) {
        <mat-spinner diameter="20"></mat-spinner>
        Saving...
      } @else {
        Save Changes
      }
    </button>
  }
</mat-dialog-actions>
